<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GraphQL Schema Documentation Generator</title>
  <!-- Load markdown-it and markdown-it-anchor -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-anchor@9.2.0/dist/markdownItAnchor.umd.js"></script>
  <style>
    body {
      font-family: Calibri, Candara, Segoe, "Segoe UI", Optima, Arial, sans-serif;
      padding: 20px;
    }
    h4 {
      background-color: aliceblue;
      padding-top: 20px;
      padding-bottom: 20px;
      display: block;
      border: 1px solid #a3d9a5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .h4-section {
      background-color: #f2fbff;
      border: 1px solid #a3d9a5;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    #content {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
    }
    /* Copy button style (if needed) */
    .copy-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 4px 8px;
      font-size: 12px;
      background-color: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.85;
      transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
    }
    .copy-btn:hover {
      opacity: 1;
      background-color: #0056b3;
    }
    pre {
      position: relative;
    }
    code.language-graphql {
      display: block;
      background-color: #e0fbe0;
      border: 1px solid #a3d9a5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      margin-left: 10%;
    }
    ul + p {
      display: block;
      background-color: #e0fbf6;
      border: 1px solid #a3d9a5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      margin-left: 10%;
    }
  </style>
</head>
<body>
  <h2>GraphQL Schema Documentation Generator</h2>
  <div id="content">Loading schema...</div>
  
  <script>
    // Initialize markdown-it with markdown-it-anchor.
    var md = window.markdownit().use(window.markdownItAnchor, {
      slugify: function(s) {
        return s.trim().toLowerCase().replace(/\s+/g, '-');
      }
    });

    // Helper: Recursively extract a type string.
    function extractType(type) {
      if (!type) return "";
      if (type.kind === "NON_NULL") {
        return extractType(type.ofType) + "!";
      } else if (type.kind === "LIST") {
        return "List[" + extractType(type.ofType) + "]";
      } else {
        return type.name || "";
      }
    }

    // Generate Markdown documentation from introspection result.
    function generateMarkdownFromSchema(introspection) {
      let schema = introspection.__schema;
      let markdown = "# GraphQL API Documentation\n\n";
      let types = schema.types;
      for (let type of types) {
        // Skip internal types.
        if (type.name.startsWith("__")) continue;
        let desc = type.description ? type.description : "No description available.";
        markdown += "## " + type.name + "\n\n" + desc + "\n\n";
        if (type.fields) {
          markdown += "### Fields:\n\n";
          for (let field of type.fields) {
            let fieldType = extractType(field.type);
            let fieldDesc = field.description ? field.description : "No description available.";
            markdown += `- **${field.name}** (\`${fieldType}\`):\n\n    ${fieldDesc}\n`;
          }
        }
        markdown += "\n---\n";
      }
      return markdown;
    }

    // Fetch introspection result from /gql endpoint.
    // This endpoint should return a JSON response with the introspection result.
    fetch('/gql', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: `
          query IntrospectionQuery {
            __schema {
              types {
                name
                description
                fields {
                  name
                  description
                  type {
                    kind
                    name
                    ofType {
                      kind
                      name
                      ofType {
                        kind
                        name
                        ofType {
                          kind
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        `
      })
    })
    .then(response => response.json())
    .then(data => {
      let markdownContent = generateMarkdownFromSchema(data.data);
      document.getElementById('content').innerHTML = md.render(markdownContent);
    })
    .catch(err => {
      document.getElementById('content').innerHTML = 'Error: ' + err;
    });
  </script>
</body>
</html>
